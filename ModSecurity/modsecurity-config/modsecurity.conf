# Configuration principale ModSecurity
SecRuleEngine On
SecRequestBodyAccess On
SecRule REQUEST_HEADERS:Content-Type "text/xml" \
    "id:'200000',phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=XML"

SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyLimitAction Reject

SecRule REQBODY_ERROR "!@eq 0" \
    "id:'200001', phase:2,t:none,log,deny,status:400,msg:'Failed to parse request body.',logdata:'%{reqbody_error_msg}',severity:2"

SecRule MULTIPART_STRICT_ERROR "!@eq 0" \
    "id:'200002',phase:2,t:none,log,deny,status:400, \
    msg:'Multipart request body failed strict validation: \
    PE %{REQBODY_PROCESSOR_ERROR}, \
    BQ %{MULTIPART_BOUNDARY_QUOTED}, \
    BW %{MULTIPART_BOUNDARY_WHITESPACE}, \
    DB %{MULTIPART_DATA_BEFORE}, \
    DA %{MULTIPART_DATA_AFTER}, \
    HF %{MULTIPART_HEADER_FOLDING}, \
    LF %{MULTIPART_LF_LINE}, \
    SM %{MULTIPART_MISSING_SEMICOLON}, \
    IQ %{MULTIPART_INVALID_QUOTING}, \
    IP %{MULTIPART_INVALID_PART}, \
    IH %{MULTIPART_INVALID_HEADER_FOLDING}, \
    FL %{MULTIPART_FILE_LIMIT_EXCEEDED}'"

SecRule MULTIPART_UNMATCHED_BOUNDARY "!@eq 0" \
    "id:'200003',phase:2,t:none,log,deny,status:400,msg:'Multipart parser detected a possible unmatched boundary.'"

SecPcreMatchLimit 1000
SecPcreMatchLimitRecursion 1000

SecRule TX:/^MSC_/ "!@streq 0" \
    "id:'200004',phase:2,t:none,deny,status:500,msg:'ModSecurity internal error flagged: %{MATCHED_VAR_NAME}'"

# Réponse body
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml
SecResponseBodyLimit 524288
SecResponseBodyLimitAction ProcessPartial

# Audit log
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/apache2/modsec_audit.log

# Règles de base pour XSS
SecRule ARGS "@detectXSS" \
    "id:'1001',phase:2,block,msg:'XSS Attack Detected in Arguments',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    tag:'application-multi',tag:'language-multi',tag:'platform-multi',\
    tag:'attack-xss',tag:'paranoia-level/1',tag:'OWASP_CRS',\
    tag:'capec/1000/152/242',ver:'OWASP_CRS/4.0.0',severity:'CRITICAL'"

# Détection de patterns XSS spécifiques
SecRule ARGS "@rx (?i)(<script[^>]*>[\s\S]*?</script[^>]*>|<script[^>]*>[\s\S]*?</script[\s]*>|<script[^>]*>[\s\S]*?</script\s*>)" \
    "id:'1002',phase:2,block,msg:'Script tag detected - XSS Attack',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    severity:'CRITICAL'"

SecRule ARGS "@rx (?i)(javascript:|vbscript:|onload=|onerror=|onmouseover=|onclick=)" \
    "id:'1003',phase:2,block,msg:'XSS Event Handler Detected',logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',severity:'HIGH'"

SecRule REQUEST_HEADERS:User-Agent "@detectXSS" \
    "id:'1004',phase:1,block,msg:'XSS Attack in User-Agent Header',logdata:'Matched Data: %{MATCHED_VAR}',severity:'HIGH'"

SecRule REQUEST_HEADERS:Referer "@detectXSS" \
    "id:'1005',phase:1,block,msg:'XSS Attack in Referer Header',logdata:'Matched Data: %{MATCHED_VAR}',severity:'HIGH'"

# Règles avancées pour DOM XSS
SecRule ARGS "@rx (?i)(document\.write|innerHTML|outerHTML|document\.cookie)" \
    "id:'1006',phase:2,block,msg:'Potential DOM XSS Pattern Detected',logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',severity:'HIGH'"

# Protection contre les bypasses
SecRule ARGS "@rx (?i)(%3c|%3e|%22|%27|%28|%29)" \
    "id:'1007',phase:2,t:urlDecode,block,msg:'URL Encoded XSS Pattern Detected',logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',severity:'MEDIUM'"