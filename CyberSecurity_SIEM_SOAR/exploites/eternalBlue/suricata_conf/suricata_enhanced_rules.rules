# Enhanced EternalBlue Detection Rules - Multi-Phase Strategy
# Version: 2.0 - Comprehensive Attack Lifecycle Detection
# Compatible with existing rules but adds progressive detection

# ============================================================================
# PHASE 1: INITIAL EXPLOITATION ATTEMPT (Existing rules improved)
# ============================================================================

# Enhanced Trans2 Sub-Command detection with additional context
alert smb any any -> $HOME_NET any (msg: "ETERNALBLUE PHASE 1 - Initial Trans2 Sub-Command Exploitation Attempt"; flow: to_server, established; content: "|FF|SMB2|00 00 00 00|"; depth: 9; offset: 4; byte_test: 2, >, 0x0008, 52, relative, little; pcre: "/\xFFSMB2\x00\x00\x00\x00.{52}(?:\x04|\x09|\x0A|\x0B|\x0C|\x0E|\x11)\x00/s"; flowbits: set, eternalblue.phase1.detected; flowbits: set, eternalblue.session.active; threshold: type limit, track by_src, seconds 120, count 1; reference: cve, 2017-0144; classtype: attempted-admin; sid: 9000001; rev: 1; metadata: attack_target Server, policy Balanced, created_at 2025_08_03, updated_at 2025_08_03;)

# Enhanced SMB3 pattern detection with session tracking
alert tcp any any -> any 445 (msg:"ETERNALBLUE PHASE 1 - SMB3 Exploit Pattern with Session Context"; content:"|00 00 10 35 ff 53 4d 42 33|"; offset:0; depth:9; content:"|41 41 41 41|"; distance:0; within:100; flowbits: set, eternalblue.phase1.smb3.detected; flowbits: set, eternalblue.session.active; threshold: type limit, track by_src, count 1, seconds 120; reference: cve, 2017-0144; classtype: attempted-admin; sid: 9000002; rev: 1; metadata: attack_target Server, policy Balanced, created_at 2025_08_03, updated_at 2025_08_03;)

# ============================================================================
# PHASE 2: BUFFER OVERFLOW & EXPLOITATION IN PROGRESS
# ============================================================================

# Massive AAAA pattern - Buffer overflow exploitation in progress
alert tcp any any -> any 445 (msg:"ETERNALBLUE PHASE 2 - Buffer Overflow Exploitation in Progress (Massive AAAA Pattern)"; flow: established, to_server; content: "|41 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41|"; within: 16; content: "|41 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41|"; distance: 0; within: 1000; content: "|41 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41|"; distance: 0; within: 1000; dsize: >1000; flowbits: isset, eternalblue.session.active; flowbits: set, eternalblue.phase2.overflow.detected; threshold: type limit, track by_src, seconds 120, count 1; reference: cve, 2017-0144; classtype: successful-admin; sid: 9000003; rev: 1; priority: 1; metadata: attack_target Server, policy Balanced, created_at 2025_08_03, updated_at 2025_08_03;)

# SMB3 with specific EternalBlue grooming pattern
alert tcp any any -> any 445 (msg:"ETERNALBLUE PHASE 2 - SMB3 Kernel Pool Grooming Pattern"; flow: established, to_server; content: "|fe|SMB"; offset: 4; depth: 4; content: "|00 00 10 35|"; distance: 0; within: 50; content: "|41 41 41 41|"; distance: 0; within: 2000; byte_test: 2, >, 1500, 2; flowbits: isset, eternalblue.session.active; flowbits: set, eternalblue.phase2.grooming.detected; threshold: type limit, track by_src, seconds 120, count 1; reference: cve, 2017-0144; classtype: successful-admin; sid: 9000004; rev: 1; priority: 1; metadata: attack_target Server, policy Balanced, created_at 2025_08_03, updated_at 2025_08_03;)

# Large packet size indicating buffer overflow attempt
alert tcp any any -> any 445 (msg:"ETERNALBLUE PHASE 2 - Oversized SMB Packet (Buffer Overflow Indicator)"; flow: established, to_server; content: "|ff|SMB"; offset: 4; depth: 4; dsize: >4000; content: "|41 41 41 41|"; within: 4000; flowbits: isset, eternalblue.session.active; flowbits: set, eternalblue.phase2.oversized.detected; threshold: type limit, track by_src, seconds 120, count 1; reference: cve, 2017-0144; classtype: successful-admin; sid: 9000005; rev: 1; priority: 1; metadata: attack_target Server, policy Balanced, created_at 2025_08_03, updated_at 2025_08_03;)

# ============================================================================
# PHASE 3: EXPLOITATION SUCCESS INDICATORS
# ============================================================================

# Generic successful SMB authentication after buffer overflow (most reliable indicator)
alert tcp any any -> any 445 (msg:"ETERNALBLUE PHASE 3 - Successful SMB Authentication After Exploitation"; flow: established, from_server; content: "|ff|SMB"; offset: 4; depth: 4; content: "|00 00 00 00|"; distance: 5; within: 4; flowbits: isset, eternalblue.phase2.overflow.detected; flowbits: set, eternalblue.phase3.success.detected; threshold: type limit, track by_dst, seconds 300, count 1; reference: cve, 2017-0144; classtype: successful-admin; sid: 9000006; rev: 2; priority: 1; metadata: attack_target Server, policy Balanced, created_at 2025_08_03, updated_at 2025_08_03;)

# New SMB session establishment from same source after buffer overflow
alert tcp any any -> any 445 (msg:"ETERNALBLUE PHASE 3 - New SMB Session After Exploitation"; flow: established, to_server; content: "|ff|SMB|72|"; offset: 4; depth: 7; flowbits: isset, eternalblue.phase2.overflow.detected; flowbits: set, eternalblue.phase3.newsession.detected; threshold: type limit, track by_src, seconds 300, count 1; reference: cve, 2017-0144; classtype: successful-admin; sid: 9000007; rev: 2; priority: 1; metadata: attack_target Server, policy Balanced, created_at 2025_08_03, updated_at 2025_08_03;)

# Server response indicating successful connection (any valid SMB response after overflow)
alert tcp any any -> any any (msg:"ETERNALBLUE PHASE 3 - Server Accepting Connections After Exploitation"; flow: established, from_server; content: "|ff|SMB"; offset: 4; depth: 4; byte_test: 1, =, 0, 9; flowbits: isset, eternalblue.phase2.overflow.detected; flowbits: set, eternalblue.phase3.server.response.detected; threshold: type limit, track by_dst, seconds 300, count 1; reference: cve, 2017-0144; classtype: successful-admin; sid: 9000008; rev: 2; priority: 1; metadata: attack_target Server, policy Balanced, created_at 2025_08_03, updated_at 2025_08_03;)

# Generic exploitation success - any successful SMB operation after buffer overflow
alert tcp any any -> any 445 (msg:"ETERNALBLUE PHASE 3 - Successful SMB Operation Post-Exploitation"; flow: established; content: "|ff|SMB"; offset: 4; depth: 4; flowbits: isset, eternalblue.phase2.overflow.detected; flowbits: set, eternalblue.phase3.operation.success; threshold: type limit, track by_flow, seconds 300, count 1; reference: cve, 2017-0144; classtype: successful-admin; sid: 9000009; rev: 1; priority: 1; metadata: attack_target Server, policy Balanced, created_at 2025_08_03, updated_at 2025_08_03;)

# ============================================================================
# PHASE 4: POST-EXPLOITATION INDICATORS
# ============================================================================

# DoublePulsar backdoor installation (common post-EternalBlue payload)
alert tcp any any -> any 445 (msg:"ETERNALBLUE POST-EXPLOIT - DoublePulsar Backdoor Installation"; flow: established, to_server; content: "|ff|SMB"; offset: 4; depth: 4; content: "|81 00 00 44|"; distance: 9; within: 10; content: "|00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00|"; distance: 0; within: 50; flowbits: isset, eternalblue.phase3.success.detected; flowbits: set, eternalblue.doublepulsar.detected; threshold: type limit, track by_src, seconds 600, count 1; reference: url, https://www.countercept.com/blog/analyzing-the-doublepulsar-kernel-dll-injection-technique/; classtype: trojan-activity; sid: 9000010; rev: 1; priority: 1; metadata: attack_target Server, policy Balanced, created_at 2025_08_03, updated_at 2025_08_03;)

# Named pipe creation for post-exploitation communication
alert smb any any -> $HOME_NET any (msg:"ETERNALBLUE POST-EXPLOIT - Suspicious Named Pipe Creation"; flow: to_server, established; content: "|fe|SMB"; offset: 4; depth: 4; content: "|05 00|"; offset: 16; depth: 2; content: "spoolss"; nocase; distance: 0; flowbits: isset, eternalblue.phase3.success.detected; flowbits: set, eternalblue.namedpipe.detected; threshold: type limit, track by_src, seconds 600, count 1; reference: cve, 2017-0144; classtype: trojan-activity; sid: 9000011; rev: 1; priority: 2; metadata: attack_target Server, policy Balanced, created_at 2025_08_03, updated_at 2025_08_03;)

# ============================================================================
# CORRELATION RULES - MULTI-PHASE DETECTION
# ============================================================================

# Full attack chain detected (Phase 1 + 2 + 3) - CRITICAL ALERT
alert tcp any any -> any any (msg:"ETERNALBLUE CRITICAL - Complete Attack Chain Detected (All Phases)"; flowbits: isset, eternalblue.phase1.detected; flowbits: isset, eternalblue.phase2.overflow.detected; flowbits: isset, eternalblue.phase3.success.detected; threshold: type limit, track by_src, seconds 600, count 1; reference: cve, 2017-0144; classtype: successful-admin; sid: 9000020; rev: 1; priority: 1; metadata: attack_target Server, policy Balanced, created_at 2025_08_03, updated_at 2025_08_03;)

# Alternative Phase 3 detection for correlation
alert tcp any any -> any any (msg:"ETERNALBLUE CRITICAL - Complete Attack Chain (Alternative Detection)"; flowbits: isset, eternalblue.phase1.detected; flowbits: isset, eternalblue.phase2.overflow.detected; flowbits: isset, eternalblue.phase3.newsession.detected; threshold: type limit, track by_src, seconds 600, count 1; reference: cve, 2017-0144; classtype: successful-admin; sid: 9000021; rev: 1; priority: 1; metadata: attack_target Server, policy Balanced, created_at 2025_08_03, updated_at 2025_08_03;)

# High probability successful exploitation (Phase 1 + 2) - HIGH ALERT  
alert tcp any any -> any any (msg:"ETERNALBLUE HIGH - Exploitation Attempt with Buffer Overflow"; flowbits: isset, eternalblue.phase1.detected; flowbits: isset, eternalblue.phase2.overflow.detected; threshold: type limit, track by_src, seconds 300, count 1; reference: cve, 2017-0144; classtype: attempted-admin; sid: 9000022; rev: 1; priority: 2; metadata: attack_target Server, policy Balanced, created_at 2025_08_03, updated_at 2025_08_03;)

# SMB3 specific successful chain
alert tcp any any -> any any (msg:"ETERNALBLUE HIGH - SMB3 Successful Exploitation Chain"; flowbits: isset, eternalblue.phase1.smb3.detected; flowbits: isset, eternalblue.phase2.overflow.detected; threshold: type limit, track by_src, seconds 300, count 1; reference: cve, 2017-0144; classtype: attempted-admin; sid: 9000023; rev: 1; priority: 2; metadata: attack_target Server, policy Balanced, created_at 2025_08_03, updated_at 2025_08_03;)

